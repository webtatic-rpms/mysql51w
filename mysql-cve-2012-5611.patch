Back-ported patch for CVE-2012-5611 --- see
http://bazaar.launchpad.net/~maria-captains/maria/5.1/revision/3168


diff -Naur mysql-5.1.66.orig/mysql-test/r/information_schema.result mysql-5.1.66/mysql-test/r/information_schema.result
--- mysql-5.1.66.orig/mysql-test/r/information_schema.result	2012-09-07 10:24:44.000000000 -0400
+++ mysql-5.1.66/mysql-test/r/information_schema.result	2012-12-04 11:04:13.247998281 -0500
@@ -1774,4 +1774,8 @@
 length(CAST(b AS CHAR))
 20
 DROP TABLE ubig;
+grant usage on *.* to mysqltest_1@localhost;
+select 1 from information_schema.tables where table_schema=repeat('a', 2000);
+1
+drop user mysqltest_1@localhost;
 End of 5.1 tests.
diff -Naur mysql-5.1.66.orig/mysql-test/t/information_schema.test mysql-5.1.66/mysql-test/t/information_schema.test
--- mysql-5.1.66.orig/mysql-test/t/information_schema.test	2012-09-07 10:24:41.000000000 -0400
+++ mysql-5.1.66/mysql-test/t/information_schema.test	2012-12-04 11:03:31.050605443 -0500
@@ -1470,6 +1470,13 @@
 
 DROP TABLE ubig;
 
+grant usage on *.* to mysqltest_1@localhost;
+connect (con1, localhost, mysqltest_1,,);
+connection con1;
+select 1 from information_schema.tables where table_schema=repeat('a', 2000);
+connection default;
+disconnect con1;
+drop user mysqltest_1@localhost;
 
 --echo End of 5.1 tests.
 
diff -Naur mysql-5.1.66.orig/sql/sql_acl.cc mysql-5.1.66/sql/sql_acl.cc
--- mysql-5.1.66.orig/sql/sql_acl.cc	2012-09-07 10:14:06.000000000 -0400
+++ mysql-5.1.66/sql/sql_acl.cc	2012-12-04 11:01:47.279638080 -0500
@@ -1351,14 +1351,20 @@
   acl_entry *entry;
   DBUG_ENTER("acl_get");
 
-  VOID(pthread_mutex_lock(&acl_cache->lock));
-  end=strmov((tmp_db=strmov(strmov(key, ip ? ip : "")+1,user)+1),db);
+  tmp_db= strmov(strmov(key, ip ? ip : "") + 1, user) + 1;
+  end= strnmov(tmp_db, db, key + sizeof(key) - tmp_db);
+
+  if (end >= key + sizeof(key)) // db name was truncated
+    DBUG_RETURN(0);             // no privileges for an invalid db name
+
   if (lower_case_table_names)
   {
     my_casedn_str(files_charset_info, tmp_db);
     db=tmp_db;
   }
   key_length= (size_t) (end-key);
+
+  VOID(pthread_mutex_lock(&acl_cache->lock));
   if (!db_is_pattern && (entry=(acl_entry*) acl_cache->search((uchar*) key,
                                                               key_length)))
   {
@@ -4327,11 +4333,17 @@
 bool check_grant_db(THD *thd,const char *db)
 {
   Security_context *sctx= thd->security_ctx;
-  char helping [NAME_LEN+USERNAME_LENGTH+2];
+  char helping [NAME_LEN+USERNAME_LENGTH+2], *end;
   uint len;
   bool error= TRUE;
 
-  len= (uint) (strmov(strmov(helping, sctx->priv_user) + 1, db) - helping) + 1;
+  end= strmov(helping, sctx->priv_user) + 1;
+  end= strnmov(end, db, helping + sizeof(helping) - end);
+
+  if (end >= helping + sizeof(helping)) // db name was truncated
+    return 1;                           // no privileges for an invalid db name
+
+  len= (uint) (end - helping) + 1;
 
   rw_rdlock(&LOCK_grant);
 
